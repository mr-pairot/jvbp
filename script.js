const liffId = '2007032148-mxreYwe5';//'2007032148-a1zrG2rP';
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIM0GsAx61Tqfpq7kHMzCYOdC47KjIQVMQO_R9OMa2iHh96RCpAu_-HCPE3m8rxAzcJA/exec';

document.addEventListener('DOMContentLoaded', function () {
  const docType = new URLSearchParams(window.location.search).get('docType');

  if (!docType || !['RFA', 'RFI', 'Letter_IN'].includes(docType)) {
    showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏ä‡πà‡∏ô ?docType=RFA');
    return;
  }

  liff.init({ liffId })
    .then(async () => {
      if (!liff.isLoggedIn()) {
        // üîÅ Redirect ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á login
        liff.login({ redirectUri: window.location.href });
        return;
      }

      const profile = await liff.getProfile();
      const userId = profile.userId;
      const displayName = profile.displayName;

      document.getElementById('loadingText').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${displayName} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${docType}...`;

      const url = `${SCRIPT_URL}?userId=${encodeURIComponent(userId)}&displayName=${encodeURIComponent(displayName)}&buttonClicked=${encodeURIComponent(docType)}&cache=${Date.now()}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.lookerUrl) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('lookerFrame').src = data.lookerUrl;
            document.getElementById('lookerContainer').style.display = 'block';
          } else {
            showError('‡πÑ‡∏°‡πà‡∏û‡∏ö Looker URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
          }
        })
        .catch(() => {
          showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        });
    })
    .catch((err) => {
      showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LIFF ‡πÑ‡∏î‡πâ: ' + err.message);
    });
});

function showError(message) {
  document.getElementById('loader').style.display = 'none';
  document.getElementById('loadingText').style.display = 'none';
  const errorEl = document.getElementById('errorMessage');
  errorEl.style.display = 'block';
  errorEl.textContent = message;
}
